name: Build and Upload macOS Distributable

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Get version from git tag
        id: get_version
        run: echo "VERSION=$(git describe --tags --abbrev=0)" >> "$GITHUB_ENV"

      - name: Grant execute permissions to Gradle
        run: chmod +x ./gradlew

      - name: Build macOS distributable
        run: ./gradlew :axer-remote-debugger:createDistributable

      - name: Create zip archive
        run: |
          cd axer-remote-debugger/build/compose/binaries/main
          zip -r Axer-Debugger-macos-${VERSION}.zip app

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: axer-remote-debugger/build/compose/binaries/main/Axer-Debugger-macos-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
